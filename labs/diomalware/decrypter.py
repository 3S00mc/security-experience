import os
import sys
import hashlib

def decrypt_file(input_file_path, output_file_path, key):
    """
    Decrypts a file encrypted with XOR.

    :param input_file_path: Path to the encrypted input file.
    :param output_file_path: Path to save the decrypted output file.
    :param key: The key used for decryption (bytes).
    """
    # Read the encrypted data from the input file
    with open(input_file_path, 'rb') as input_file:
        encrypted_data = input_file.read()

    # Decrypt using XOR with key repeated
    decrypted_data = bytes([b ^ key[i % len(key)] for i, b in enumerate(encrypted_data)])

    # Write the decrypted data to the output file
    with open(output_file_path, 'wb') as output_file:
        output_file.write(decrypted_data)

if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("Usage: python decrypter.py <input_file> <output_file>")
        sys.exit(1)
    
    input_file = sys.argv[1]
    output_file = sys.argv[2]
    
    # Load key from key.txt and derive a 32-byte key using SHA-256
    with open('key.txt', 'r') as f:
        key_str = f.read().strip()
    
    key = hashlib.sha256(key_str.encode()).digest()
    
    decrypt_file(input_file, output_file, key)
    print(f"File decrypted successfully: {output_file}")

    # Optional: Remove the encrypted file after decryption
    os.remove(input_file)
    print(f"Encrypted file removed: {input_file}")